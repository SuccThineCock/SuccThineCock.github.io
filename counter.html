<!doctype html>
<meta charset="utf-8" />
<title>counter widget</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, increment }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---- your Firebase config (from the console) ----
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    appId: "YOUR_APP_ID"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // page key from query (?page=/about). Use "global" if empty.
  const page = (new URLSearchParams(location.search).get("page") || "global");
  const key = encodeURIComponent(page);
  const ref = doc(db, "counters", key);

  // simple “once per tab” guard to reduce spam on reload
  const ssKey = `visited:${key}`;
  const already = sessionStorage.getItem(ssKey);

  async function bump() {
    let snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, { count: 1 });
      return 1;
    } else {
      // only increment if we haven't in this tab yet
      if (!already) {
        await updateDoc(ref, { count: increment(1) });
        sessionStorage.setItem(ssKey, "1");
      }
      snap = await getDoc(ref);
      return snap.data().count;
    }
  }

  try {
    const count = await bump();
    parent.postMessage({ type: "counter", page, count }, "*");
  } catch (e) {
    console.error(e);
    parent.postMessage({ type: "counter", page, count: "ERR" }, "*");
  }
</script>
