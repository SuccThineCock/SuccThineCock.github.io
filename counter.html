<!doctype html>
<meta charset="utf-8">
<title>counter widget</title>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, increment }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  // ---- your Firebase config (from the console) ----
  const firebaseConfig = { 
  apiKey: "AIzaSyAtmGNKXV9MbiIfuodHGUZnM09mBavSKB0",
  authDomain: "neobrie-bcdd0.firebaseapp.com",
  projectId: "neobrie-bcdd0",
  appId: "1:877440779773:web:d948cef63646d1bdf54594"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 2. Key (per-page or global)
  const params = new URLSearchParams(location.search);
  const page = params.get("page") || "global";
  const ref = doc(db, "counters", encodeURIComponent(page));

  async function bump() {
    let snap = await getDoc(ref);
    if (!snap.exists()) {
      await setDoc(ref, { count: 1 });
      return 1;
    } else {
      await updateDoc(ref, { count: increment(1) });
      snap = await getDoc(ref);
      return snap.data().count;
    }
  }

  try {
    const count = await bump();
    // Send back to parent page
    parent.postMessage({ type: "counter", page, count }, "*");
  } catch (err) {
    console.error("Counter error:", err);
    parent.postMessage({ type: "counter", page, count: "ERR" }, "*");
  }
</script>
